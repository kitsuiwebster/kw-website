<div class="tasks">
  <div class="tasks-container">
    <header class="tasks-header">
      <div class="header-top">
        <h1 class="tasks-title">KW Task Manager</h1>
        <div class="header-actions">
          <button class="toggle-filter-btn" [class.active]="showFilterRow" (click)="showFilterRow = !showFilterRow">Filter</button>
          <button class="order-btn" (click)="openOrderModal()">
            Order: {{ getSortOrderLabel() }}
          </button>
          <button class="edit-labels-btn" (click)="openLabelEditor()">Edit labels</button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-row">
        <div class="tab-navigation">
          <button
            class="tab-btn"
            [class.active]="activeTab === 'kitsui'"
            (click)="switchTab('kitsui')"
          >
            Kitsui
          </button>
          <button
            class="tab-btn"
            [class.active]="activeTab === 'bubble'"
            (click)="switchTab('bubble')"
          >
            Bubble
          </button>
        </div>
        <button
          class="tab-btn history-tab-btn"
          [class.active]="!showHistory"
          (click)="showTasksView()"
        >
          Tasks
        </button>
        <button
          class="tab-btn history-tab-btn"
          [class.active]="showHistory"
          (click)="toggleHistory()"
        >
          History
        </button>
      </div>
    </header>

    <div class="tasks-input-section">
      <div class="label-row">
        <div class="label-radio-group">
        <div class="label-radio-item" *ngFor="let label of currentLabels">
          <input
            type="radio"
            [id]="'label-' + label.id"
            [value]="label.id"
            [(ngModel)]="selectedLabel"
            [name]="activeTab + 'TaskLabel'"
            class="label-radio-input"
            (change)="taskInput.focus()"
          >
          <label 
            [for]="'label-' + label.id"
            class="label-radio-label"
            [style.border-color]="label.color"
            [style.--label-color]="label.color"
          >
            <span 
              class="label-color-dot" 
              [style.background-color]="label.color"
            ></span>
            {{ label.name }}
          </label>
        </div>
        </div>
      </div>
      <div class="input-and-button">
        <input
          #taskInput
          type="text"
          [(ngModel)]="newTaskText"
          (keypress)="onKeyPress($event)"
          placeholder="Add a new task..."
          class="tasks-input"
          maxlength="200"
        >
        <button 
          (click)="addTask()" 
          class="tasks-add-btn"
          [disabled]="!newTaskText.trim()"
        >
          +
        </button>
      </div>
    </div>

    <!-- Filtre par label -->
    <div class="filter-row" *ngIf="!isLoading && showFilterRow">
      <span
        *ngFor="let label of currentLabels"
        class="filter-pill"
        [class.active]="filterLabel === label.id"
        [style.--label-color]="label.color"
        (click)="toggleFilterLabel(label.id)"
      >
        <span class="label-color-dot" [style.background-color]="label.color"></span>
        {{ label.name }}
      </span>
    </div>

    <div class="tasks-columns" *ngIf="!showHistory">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading {{ activeTab }} tasks...</p>
      </div>

      <!-- Left Column: All Tasks -->
      <div class="tasks-column" *ngIf="!isLoading">
        <div class="column-header">
          <h2 class="column-title">All Tasks <span class="task-count">{{ sortedTasks.length }}<ng-container *ngIf="filterLabel">/{{ sortedTasksTotal }}</ng-container></span></h2>
        </div>
        <div 
          class="tasks-list drop-zone"
          (dragover)="onDragOver($event)"
          (drop)="onDropToTasks($event)"
        >
          <div 
            *ngFor="let task of sortedTasks" 
            class="task-item"
            [class.completed]="task.completed"
            [class.priority-task]="task.isPriority"
            draggable="true"
            (dragstart)="onDragStart($event, task)"
          >
            <label class="task-checkbox-container">
              <input 
                type="checkbox" 
                [checked]="task.completed"
                (change)="toggleTask(task)"
                class="task-checkbox"
              >
              <span class="task-checkmark"></span>
            </label>
            
            <span class="task-text">{{ task.text }}</span>
            
            <span
              *ngIf="task.label"
              class="task-label"
              [style.background-color]="getLabelColor(task.label)"
              [style.color]="getTextColorForLabel(task.label)"
              [title]="getLabelName(task.label)"
            >
              {{ getLabelName(task.label) }}
            </span>
            
            <button 
              (click)="openTaskModal(task)" 
              class="task-menu-btn"
              title="Options"
            >
              ⋯
            </button>
          </div>
          
          <div class="tasks-empty" *ngIf="sortedTasks.length === 0">
            <p class="tasks-empty-text">No tasks yet. Add one above!</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Today Tasks -->
      <div class="tasks-column" *ngIf="!isLoading">
        <div class="column-header">
          <h2 class="column-title">Today <span class="task-count">{{ todayTasks.length }}</span></h2>
        </div>
        <div 
          class="tasks-list drop-zone today-zone"
          (dragover)="onDragOver($event)"
          (drop)="onDropToToday($event)"
        >
          <div 
            *ngFor="let task of todayTasks" 
            class="task-item today-task"
            [class.completed]="task.completed"
            [class.priority-task]="task.isPriority"
            draggable="true"
            (dragstart)="onDragStart($event, task)"
          >
            <label class="task-checkbox-container">
              <input 
                type="checkbox" 
                [checked]="task.completed"
                (change)="toggleTask(task)"
                class="task-checkbox"
              >
              <span class="task-checkmark"></span>
            </label>
            
            <span class="task-text">{{ task.text }}</span>
            
            <span
              *ngIf="task.label"
              class="task-label"
              [style.background-color]="getLabelColor(task.label)"
              [style.color]="getTextColorForLabel(task.label)"
              [title]="getLabelName(task.label)"
            >
              {{ getLabelName(task.label) }}
            </span>
            
            <button 
              (click)="openTaskModal(task)" 
              class="task-menu-btn"
              title="Options"
            >
              ⋯
            </button>
          </div>
          
          <div class="tasks-empty" *ngIf="todayTasks.length === 0">
            <p class="tasks-empty-text">Drag tasks here for today!</p>
          </div>
        </div>
      </div>
    </div>

    <div class="history-view" *ngIf="!isLoading && showHistory">
      <div class="history-day-block" *ngFor="let group of completedHistoryGroups">
        <h2 class="history-day-title">{{ group.dayLabel }}</h2>
        <div class="history-day-list">
          <div class="history-item" *ngFor="let task of group.tasks">
            <span class="history-time">{{ formatHistoryTime(task) }}</span>
            <span class="history-text">{{ task.text }}</span>
            <span
              *ngIf="task.label"
              class="task-label history-label"
              [style.background-color]="getLabelColor(task.label)"
              [style.color]="getTextColorForLabel(task.label)"
              [title]="getLabelName(task.label)"
            >
              {{ getLabelName(task.label) }}
            </span>
          </div>
        </div>
      </div>

      <div class="tasks-empty" *ngIf="completedHistoryGroups.length === 0">
        <p class="tasks-empty-text">No completed task history yet.</p>
      </div>
    </div>

    <!-- Affichage des erreurs -->
    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>
  </div>

  <!-- Modal éditeur de labels -->
  <div
    *ngIf="showLabelEditor"
    class="modal-overlay"
    (click)="closeLabelEditor()"
  >
    <div class="task-modal label-editor-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Labels — {{ activeTab }}</h3>
        <button (click)="closeLabelEditor()" class="close-btn">×</button>
      </div>
      <div class="modal-content">
        <div class="label-editor-list">
          <div *ngFor="let label of editingLabels; let i = index" class="label-editor-row">
            <span class="label-preview-dot" [style.background-color]="label.color"></span>
            <input
              type="text"
              [(ngModel)]="label.name"
              class="label-name-input"
              maxlength="20"
            >
            <div class="hex-input-wrapper">
              <span class="hex-prefix">#</span>
              <input
                type="text"
                [ngModel]="label.color.slice(1)"
                (ngModelChange)="updateEditingHex(i, $event)"
                class="label-hex-input"
                maxlength="6"
                placeholder="FFD700"
              >
            </div>
            <button class="delete-label-btn" (click)="deleteEditingLabel(i)">×</button>
          </div>
        </div>
        <button class="add-label-btn" (click)="addEditingLabel()">+ Add label</button>
        <button (click)="saveLabelChanges()" class="save-labels-btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal des actions -->
  <div 
    *ngIf="showTaskModal" 
    class="modal-overlay"
    (click)="closeTaskModal()"
  >
    <div class="task-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Task Actions</h3>
        <button (click)="closeTaskModal()" class="close-btn">×</button>
      </div>
      
      <div class="modal-content" *ngIf="selectedTask">
        <div class="task-preview">
          <strong>{{ selectedTask.text }}</strong>
          <span class="task-info">
            {{ getLabelName(selectedTask.label || '') }}
            <span *ngIf="selectedTask.isPriority" class="priority-badge">Pinned</span>
          </span>
        </div>
        
        <div class="modal-actions">
          <div class="action-btn rename-btn" [class.renaming]="isRenaming">
            <div *ngIf="!isRenaming" (click)="startRename()" class="rename-trigger">
              Rename
            </div>
            <div *ngIf="isRenaming" class="rename-input-container">
              <input 
                [(ngModel)]="renameText"
                (keydown)="onRenameKeyPress($event)"
                (blur)="saveRename()"
                class="rename-input"
                #renameInput
                maxlength="200"
              >
              <div class="rename-actions">
                <button (click)="saveRename()" class="save-btn">✓</button>
                <button (click)="cancelRename()" class="cancel-btn">×</button>
              </div>
            </div>
          </div>
          
          <button (click)="toggleTaskPriority()" class="action-btn priority-btn">
            <span *ngIf="!selectedTask.isPriority">Pin</span>
            <span *ngIf="selectedTask.isPriority">Unpin</span>
          </button>

          <button (click)="deleteTaskFromModal()" class="action-btn delete-btn">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Order -->
  <div
    *ngIf="showOrderModal"
    class="modal-overlay"
    (click)="closeOrderModal()"
  >
    <div class="task-modal order-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Order Tasks</h3>
        <button (click)="closeOrderModal()" class="close-btn">×</button>
      </div>
      <div class="modal-content">
        <div class="order-options">
          <button
            class="order-option-btn"
            [class.active]="sortOrder === 'default'"
            (click)="selectSortOrder('default')"
          >
            <span class="option-label">Default</span>
            <span class="option-description">Priority first, then creation order</span>
          </button>
          <button
            class="order-option-btn"
            [class.active]="sortOrder === 'alphabetical'"
            (click)="selectSortOrder('alphabetical')"
          >
            <span class="option-label">Alphabetical (A-Z)</span>
            <span class="option-description">Sort by task name</span>
          </button>
          <button
            class="order-option-btn"
            [class.active]="sortOrder === 'newest'"
            (click)="selectSortOrder('newest')"
          >
            <span class="option-label">Newest First</span>
            <span class="option-description">Recently created tasks first</span>
          </button>
          <button
            class="order-option-btn"
            [class.active]="sortOrder === 'oldest'"
            (click)="selectSortOrder('oldest')"
          >
            <span class="option-label">Oldest First</span>
            <span class="option-description">Oldest tasks first</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
